{% extends 'base.html' %}

{% block title %}Backend Video with Chat{% endblock %}
{% block content %}
<style>
    .main-content {
        display: flex;
        margin: 0;
        font-family: Arial, sans-serif;
    }

    .video-container {
        flex: 2;
        padding: 20px;
    }

    .chat-container {
        flex: 1;
        margin-top: 37px;
        border-left: 1px solid #ccc;
        padding: 20px;
        display: flex;
        flex-direction: column;
        height: 85vh;
        box-sizing: border-box;
    }

    /* Chat message styling */
    .chat-message {
        /* max-width: 70%; */
        padding: 10px 15px;
        margin: 8px 0;
        border-radius: 15px;
        line-height: 1.4;
        /* display: inline-block; */
        clear: both;
        word-wrap: break-word;
        font-size: 14px;
        display: block; 
        width: fit-content; 
    }

    .chat-message.user {
        background-color: rgba(173, 216, 230, 0.7); /* WhatsApp green */
        align-self: flex-end;
        text-align: right;
        border-bottom-right-radius: 0;
    }

    .chat-message.bot {
        background-color: #faf8f8bc;
        align-self: flex-start;
        text-align: left;
        border-bottom-left-radius: 0;
    }

    #chat-box {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
    }

    #chat-input {
        display: flex;
    }

    #chat-input input {
        flex: 1;
        padding: 8px;
    }

    #chat-input button {
        padding: 8px 12px;
    }
</style>

<div class="main-content">
    <div class="video-container">
        <h1>Backend Video</h1>
        <img src="{{ url_for('video_feed') }}" width="720" />
    </div>
    <div class="chat-container">
        <h2>Chat with Eva</h2>
        <div id="chat-box"></div>
        <form id="chat-input">
            <input type="text" id="user-input" placeholder="Type a message..." required />
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const chatInputForm = document.getElementById('chat-input');
    const userInput = document.getElementById('user-input');

    chatInputForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (message === '') return;

        const userMessage = document.createElement('div');
        userMessage.textContent = 'You: ' + message;
        userMessage.className = 'chat-message user';
        chatBox.appendChild(userMessage);

        userInput.value = '';

        const response = await fetch('/gemini_chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const data = await response.json();
        const botMessage = document.createElement('div');
        botMessage.textContent = 'Eva: ' + data.response;
        botMessage.className = 'chat-message bot';
        chatBox.appendChild(botMessage);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    setInterval(async () => {
        const response = await fetch('/system_chat');
        const data = await response.json();
        if (data.response) {
            const botMessage = document.createElement('div');
            botMessage.textContent = 'Eva: ' + data.response;
            botMessage.className = 'chat-message bot';
            chatBox.appendChild(botMessage);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }, 2000);
</script>
{% endblock %}
